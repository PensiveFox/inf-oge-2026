<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ—Å–º–æ—Ç—Ä –ø—É—Ç–µ–π –≥—Ä–∞—Ñ–∞</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .selector-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            padding: 20px;
            max-width: 500px;
            margin: 0 auto 30px;
        }
        
        .selector-container h3 {
            margin-bottom: 15px;
            color: #333;
        }
        
        select, input {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        select:focus, input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        button {
            padding: 12px 24px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            margin: 5px;
        }
        
        button.primary {
            background: #667eea;
            color: white;
        }
        
        button.primary:hover {
            background: #5568d3;
        }
        
        button.secondary {
            background: #f0f0f0;
            color: #333;
        }
        
        button.secondary:hover {
            background: #e0e0e0;
        }
        
        .viewer-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            padding: 30px;
            max-width: 1400px;
            margin: 0 auto;
            display: none;
        }
        
        .viewer-content {
            display: flex;
            gap: 30px;
        }
        
        .main-viewer {
            flex: 1;
        }
        
        .paths-history {
            width: 300px;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            max-height: 600px;
            overflow-y: auto;
        }
        
        .paths-history h3 {
            margin-bottom: 15px;
            color: #333;
            font-size: 18px;
        }
        
        .path-item {
            padding: 10px;
            margin: 8px 0;
            background: white;
            border-radius: 6px;
            border-left: 4px solid #ddd;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .path-item.completed {
            border-left-color: #27ae60;
            opacity: 0.7;
        }
        
        .path-item.current {
            border-left-color: #667eea;
            background: #e8f4f8;
            font-weight: bold;
        }
        
        .path-item-number {
            color: #667eea;
            font-weight: bold;
            margin-right: 8px;
        }
        
        .viewer-container.active {
            display: block;
        }
        
        .frame-display {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .frame-display img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .frame-info {
            text-align: center;
            margin-bottom: 15px;
            font-size: 18px;
            color: #333;
            font-weight: 500;
        }
        
        .thumbnails {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .thumbnail {
            cursor: pointer;
            border: 3px solid transparent;
            border-radius: 8px;
            transition: all 0.3s ease;
            width: 120px;
            height: 80px;
            object-fit: cover;
        }
        
        .thumbnail:hover {
            transform: scale(1.05);
        }
        
        .thumbnail.active {
            border-color: #667eea;
            box-shadow: 0 0 15px rgba(102, 126, 234, 0.5);
        }
        
        .project-info {
            background: #f0f8ff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <h1>üó∫Ô∏è –ü—Ä–æ—Å–º–æ—Ç—Ä –ø—É—Ç–µ–π –≥—Ä–∞—Ñ–∞</h1>
    
    <div class="selector-container">
        <h3>–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç</h3>
        <select id="folderSelect" onchange="loadProject()">
            <option value="">-- –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–µ–∫—Ç–æ–≤... --</option>
        </select>
        <p style="margin-top: 10px; color: #666; font-size: 14px;">
            üí° –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç –∏–∑ —Å–ø–∏—Å–∫–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø—É—Ç–µ–π
        </p>
    </div>
    
    <div class="viewer-container" id="viewerContainer">
        <div class="project-info" id="projectInfo"></div>
        
        <div class="viewer-content">
            <div class="main-viewer">
        
        <div class="frame-info">
            <div style="margin-bottom: 10px;">
                <strong>–ü—É—Ç—å <span id="currentPath">-</span>:</strong> <span id="pathDescription">-</span>
            </div>
            –ö–∞–¥—Ä <span id="currentFrame">1</span> –∏–∑ <span id="totalFrames">0</span>
        </div>
        
        <div class="frame-display">
            <img id="mainImage" src="" alt="–ö–∞–¥—Ä –ø—É—Ç–∏">
        </div>
        
        <div class="controls" style="margin-bottom: 15px;">
            <button class="secondary" onclick="previousPath()">‚è™ –ü—Ä–µ–¥. –ø—É—Ç—å</button>
            <button class="secondary" onclick="nextPath()">–°–ª–µ–¥. –ø—É—Ç—å ‚è©</button>
        </div>
        
        <div class="controls">
            <button class="secondary" id="prevBtn" onclick="previousFrame()">‚¨ÖÔ∏è –ü—Ä–µ–¥—ã–¥—É—â–∏–π</button>
            <button class="primary" id="playBtn" onclick="toggleAutoPlay()">‚ñ∂Ô∏è –ê–≤—Ç–æ–ø–æ–∫–∞–∑</button>
            <button class="secondary" id="nextBtn" onclick="nextFrame()">–°–ª–µ–¥—É—é—â–∏–π ‚û°Ô∏è</button>
        </div>
        
        <div class="thumbnails" id="thumbnailsContainer"></div>
        
            </div>
            
            <div class="paths-history">
                <h3>üìã –ò—Å—Ç–æ—Ä–∏—è –ø—É—Ç–µ–π</h3>
                <div id="pathsList"></div>
            </div>
        </div>
    </div>
    
    <script>
        let currentFrame = 1;
        let totalFrames = 0;
        let autoPlayInterval = null;
        let isPlaying = false;
        let cacheVersion = Date.now();
        let currentFolder = '';
        let projectInfo = null;
        let currentPathIndex = 0;
        let pathGroups = [];
        
        async function loadProjectList() {
            try {
                const response = await fetch('output/');
                const text = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(text, 'text/html');
                const links = doc.querySelectorAll('a');
                const folders = [];
                
                for (const link of links) {
                    const href = link.getAttribute('href');
                    if (href && href.endsWith('/') && !href.startsWith('..') && href !== '/') {
                        folders.push(href.replace('/', ''));
                    }
                }
                
                const select = document.getElementById('folderSelect');
                select.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç --</option>';
                
                if (folders.length === 0) {
                    select.innerHTML = '<option value="">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤</option>';
                } else {
                    folders.forEach(folder => {
                        const option = document.createElement('option');
                        option.value = folder;
                        option.textContent = folder;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                document.getElementById('folderSelect').innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞</option>';
            }
        }
        
        async function loadProject() {
            const folderName = document.getElementById('folderSelect').value;
            if (!folderName) {
                return;
            }
            
            currentFolder = `output/${folderName}`;
            
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º info.json
                const response = await fetch(`${currentFolder}/info.json`);
                if (!response.ok) throw new Error('–ü—Ä–æ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω');
                
                projectInfo = await response.json();
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø –ø—Ä–æ–µ–∫—Ç–∞ (–∞–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∏–ª–∏ —Å—Ç–∞—Ç–∏—á–Ω—ã–π)
                const isAnimated = projectInfo.animation_type === 'progressive';
                totalFrames = isAnimated ? projectInfo.total_frames : projectInfo.total_paths;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–æ–µ–∫—Ç–µ
                let infoHTML = `
                    <strong>–ü—Ä–æ–µ–∫—Ç:</strong> ${projectInfo.project_name}<br>
                    <strong>–°–æ–∑–¥–∞–Ω:</strong> ${new Date(projectInfo.created).toLocaleString('ru-RU')}<br>
                `;
                
                if (isAnimated) {
                    infoHTML += `
                        <strong>–¢–∏–ø:</strong> –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π üé¨<br>
                        <strong>–í—Å–µ–≥–æ –∫–∞–¥—Ä–æ–≤:</strong> ${totalFrames} (${projectInfo.total_paths} –ø—É—Ç–µ–π)<br>
                    `;
                } else {
                    infoHTML += `<strong>–í—Å–µ–≥–æ –ø—É—Ç–µ–π:</strong> ${totalFrames}<br>`;
                }
                
                document.getElementById('projectInfo').innerHTML = infoHTML;
                
                document.getElementById('totalFrames').textContent = totalFrames;
                document.getElementById('viewerContainer').classList.add('active');
                
                currentFrame = 1;
                groupFramesByPath();
                generateThumbnails();
                updateFrame();
                
            } catch (error) {
                alert(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞: ${error.message}\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –ø–∞–ø–∫–∞ ${currentFolder} —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ñ–∞–π–ª—ã.`);
            }
        }
        
        function generateThumbnails() {
            const container = document.getElementById('thumbnailsContainer');
            container.innerHTML = '';
            
            const isAnimated = projectInfo.animation_type === 'progressive';
            
            if (isAnimated) {
                // –î–ª—è –∞–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–∏–Ω–∏–∞—Ç—é—Ä—ã –∫–ª—é—á–µ–≤—ã—Ö –∫–∞–¥—Ä–æ–≤
                const keyFrames = [];
                let currentPathIdx = 0;
                
                // –ù–∞—Ö–æ–¥–∏–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∫–∞–¥—Ä—ã –∫–∞–∂–¥–æ–≥–æ –ø—É—Ç–∏
                for (let i = 0; i < projectInfo.frames.length; i++) {
                    const frame = projectInfo.frames[i];
                    if (frame.path_index !== currentPathIdx) {
                        currentPathIdx = frame.path_index;
                    }
                    // –ë–µ—Ä—ë–º –ø–µ—Ä–≤—ã–π –∏ –ø–æ—Å–ª–µ–¥–Ω–∏–π –∫–∞–¥—Ä –∫–∞–∂–¥–æ–≥–æ –ø—É—Ç–∏
                    if (frame.step === 1 || i === projectInfo.frames.length - 1 || 
                        (i < projectInfo.frames.length - 1 && projectInfo.frames[i + 1].path_index !== frame.path_index)) {
                        keyFrames.push(frame.number);
                    }
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∫–ª—é—á–µ–≤—ã–µ –∫–∞–¥—Ä—ã –∫–∞–∫ –º–∏–Ω–∏–∞—Ç—é—Ä—ã
                keyFrames.slice(0, 20).forEach(frameNum => {
                    const img = document.createElement('img');
                    img.src = `${currentFolder}/frame_${String(frameNum).padStart(4, '0')}.png`;
                    img.className = 'thumbnail' + (frameNum === 1 ? ' active' : '');
                    img.alt = `–ö–∞–¥—Ä ${frameNum}`;
                    img.onclick = () => goToFrame(frameNum);
                    container.appendChild(img);
                });
            } else {
                // –î–ª—è —Å—Ç–∞—Ç–∏—á–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ
                for (let i = 1; i <= totalFrames; i++) {
                    const img = document.createElement('img');
                    img.src = `${currentFolder}/path_${String(i).padStart(2, '0')}.png`;
                    img.className = 'thumbnail' + (i === 1 ? ' active' : '');
                    img.alt = `–ü—É—Ç—å ${i}`;
                    img.title = projectInfo.paths[i-1];
                    img.onclick = () => goToFrame(i);
                    container.appendChild(img);
                }
            }
        }
        
        function updateFrame() {
            const isAnimated = projectInfo.animation_type === 'progressive';
            
            if (isAnimated) {
                document.getElementById('mainImage').src = `${currentFolder}/frame_${String(currentFrame).padStart(4, '0')}.png`;
            } else {
                document.getElementById('mainImage').src = `${currentFolder}/path_${String(currentFrame).padStart(2, '0')}.png`;
            }
            
            document.getElementById('currentFrame').textContent = currentFrame;
            
            document.getElementById('prevBtn').disabled = currentFrame === 1;
            document.getElementById('nextBtn').disabled = currentFrame === totalFrames;
            
            document.querySelectorAll('.thumbnail').forEach((thumb, index) => {
                thumb.classList.toggle('active', index + 1 === currentFrame);
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—É—Ç–∏
            updatePathInfo();
        }
        
        function groupFramesByPath() {
            if (!projectInfo || !projectInfo.frames) return;
            
            pathGroups = [];
            let currentGroup = [];
            let lastPathIndex = 0;
            
            projectInfo.frames.forEach(frame => {
                if (frame.path_index !== lastPathIndex && currentGroup.length > 0) {
                    pathGroups.push(currentGroup);
                    currentGroup = [];
                }
                currentGroup.push(frame.number);
                lastPathIndex = frame.path_index;
            });
            
            if (currentGroup.length > 0) {
                pathGroups.push(currentGroup);
            }
        }
        
        function updatePathInfo() {
            if (!projectInfo || pathGroups.length === 0) return;
            
            // –ù–∞—Ö–æ–¥–∏–º, –∫ –∫–∞–∫–æ–º—É –ø—É—Ç–∏ –æ—Ç–Ω–æ—Å–∏—Ç—Å—è —Ç–µ–∫—É—â–∏–π –∫–∞–¥—Ä
            for (let i = 0; i < pathGroups.length; i++) {
                if (pathGroups[i].includes(currentFrame)) {
                    currentPathIndex = i;
                    break;
                }
            }
            
            document.getElementById('currentPath').textContent = `${currentPathIndex + 1}/${pathGroups.length}`;
            if (projectInfo.paths && projectInfo.paths[currentPathIndex]) {
                document.getElementById('pathDescription').textContent = projectInfo.paths[currentPathIndex];
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ø—É—Ç–µ–π
            updatePathsList();
        }
        
        function updatePathsList() {
            if (!projectInfo || !projectInfo.frames) return;
            
            const container = document.getElementById('pathsList');
            container.innerHTML = '';
            
            // –ù–∞—Ö–æ–¥–∏–º —Ç–µ–∫—É—â–∏–π –∫–∞–¥—Ä –≤ –º–∞—Å—Å–∏–≤–µ frames
            const currentFrameInfo = projectInfo.frames.find(f => f.number === currentFrame);
            if (!currentFrameInfo) return;
            
            const currentPathIdx = currentFrameInfo.path_index;
            const isLastStepOfPath = currentFrameInfo.step === projectInfo.frames.filter(f => f.path_index === currentPathIdx).length;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –ü–û–õ–ù–û–°–¢–¨–Æ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ –ø—É—Ç–∏
            const completedPathsCount = isLastStepOfPath ? currentPathIdx : currentPathIdx - 1;
            
            for (let i = 0; i < completedPathsCount; i++) {
                const pathDiv = document.createElement('div');
                pathDiv.className = 'path-item completed';
                pathDiv.innerHTML = `
                    <span class="path-item-number">${i + 1}.</span>
                    ${projectInfo.paths[i]}
                `;
                container.appendChild(pathDiv);
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π —Å—Ç—Ä–æ—è—â–∏–π—Å—è –ø—É—Ç—å –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –æ–Ω –µ—â—ë –Ω–µ –∑–∞–≤–µ—Ä—à—ë–Ω
            if (!isLastStepOfPath) {
                const currentPathDiv = document.createElement('div');
                currentPathDiv.className = 'path-item current';
                currentPathDiv.innerHTML = `
                    <span class="path-item-number">${currentPathIdx}.</span>
                    ${currentFrameInfo.current_path}
                `;
                container.appendChild(currentPathDiv);
            }
        }
        
        function nextPath() {
            if (currentPathIndex < pathGroups.length - 1) {
                currentPathIndex++;
                currentFrame = pathGroups[currentPathIndex][0];
                updateFrame();
            }
        }
        
        function previousPath() {
            if (currentPathIndex > 0) {
                currentPathIndex--;
                currentFrame = pathGroups[currentPathIndex][0];
                updateFrame();
            }
        }
        
        function nextFrame() {
            if (currentFrame < totalFrames) {
                currentFrame++;
                updateFrame();
            } else if (isPlaying) {
                // –î–æ—Å—Ç–∏–≥–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∫–∞–¥—Ä–∞ - –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–≤—Ç–æ–ø–æ–∫–∞–∑
                toggleAutoPlay();
            }
        }
        
        function previousFrame() {
            if (currentFrame > 1) {
                currentFrame--;
                updateFrame();
            }
        }
        
        function goToFrame(frameNumber) {
            currentFrame = frameNumber;
            updateFrame();
        }
        
        function toggleAutoPlay() {
            const playBtn = document.getElementById('playBtn');
            
            if (isPlaying) {
                clearInterval(autoPlayInterval);
                playBtn.textContent = '‚ñ∂Ô∏è –ê–≤—Ç–æ–ø–æ–∫–∞–∑';
                playBtn.classList.remove('secondary');
                playBtn.classList.add('primary');
                isPlaying = false;
            } else {
                autoPlayInterval = setInterval(nextFrame, 500);  // 0.5 —Å–µ–∫—É–Ω–¥—ã - –ø–ª–∞–≤–Ω–æ –∏ –Ω–µ –º–µ–¥–ª–µ–Ω–Ω–æ
                playBtn.textContent = '‚è∏Ô∏è –ü–∞—É–∑–∞';
                playBtn.classList.remove('primary');
                playBtn.classList.add('secondary');
                isPlaying = true;
            }
        }
        
        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (document.getElementById('viewerContainer').classList.contains('active')) {
                if (e.key === 'ArrowLeft') previousFrame();
                if (e.key === 'ArrowRight') nextFrame();
                if (e.key === ' ') {
                    e.preventDefault();
                    toggleAutoPlay();
                }
            }
        });
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–µ–∫—Ç–æ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        loadProjectList();
    </script>
</body>
</html>
